<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>물류팀대시보드(전체)</title>
</head>

<body>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <style>
        input[type="checkbox"][disabled] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #000;
            border-radius: 3px;
            background-color: #fff;
            cursor: not-allowed;
        }

        input[type="checkbox"][disabled]:checked {
            background-color: #000;
            position: relative;
        }

        input[type="checkbox"][disabled]:checked::after {
            content: "✔";
            color: #fff;
            font-size: 14px;
            position: absolute;
            top: -2px;
            left: 2px;
        }

        #actionButtons {
            display: flex;
            justify-content: center;
            /* 가로 가운데 정렬 */
            gap: 15px;
            /* 버튼 사이 간격 */
            margin-top: 20px;
        }

        #actionButtons button {
            padding: 8px 16px;
            font-size: 14px;
            border: 1px solid #888;
            border-radius: 5px;
            background-color: #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        #actionButtons button:hover {
            background-color: #e0e0e0;
        }

        table.dataTable td {
            text-align: center;
        }
    </style>
        
    <h2>물류팀 대시보드(전체)</h2>
    <table id="grid" class="display" style="width:100%"></table>

    <!-- 버튼 영역 -->
    <div id="actionButtons">
        <button id="btnDetail">상세보기</button>
        <button id="btnPicking">피킹완료</button>
        <button id="btnOutReady">출고준비완료</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        $(document).ready(function () {
            const table = $('#grid').DataTable({
                responsive: true,
                ajax: '/api/print-info/list1',
                columns: [
                    {
                        title: '',  // 체크박스 컬럼
                        orderable: false,
                        className: 'dt-body-center',
                        render: function (data, type, row, meta) {
                            return `<input type="checkbox" class="row-select">`;
                        }
                    },
                    {data: 'pickingDate', title: '피킹예정일', className: 'dt-center'},
                    {data: 'printTeam', title: '담당팀'},
                    {data: 'companyContact', title: '업체명(고객명)'},
                    {data: 'itemName', title: '품목명'},
                    {data: 'bagColor', title: '컬러'},
                    {data: 'size', title: '사이즈'},
                    {data: 'quantity', title: '장수'},
                    {
                        data: "pickingYn", title: "피킹완료"
                        , className: 'dt-center'
                        , render: function (data, type, row) {
                            if (type === 'display') {
                                return `<input type="checkbox" ${data == '1' ? 'checked' : ''} disabled>`;
                            }
                            return data;
                        }
                    },
                    {data: 'phoneNumber', title: '전화번호'},
                    {data: 'deliveryZip', title: '우편번호', className: 'dt-center'},
                    {data: 'deliveryAddress', title: '주소'},
                    {data: 'sizeText', title: '박스규격'},
                    {data: 'printMethod', title: '발송마감일', className: 'dt-center'},
                    {
                        data: "outReadyYn", title: "출고준비"
                        , className: 'dt-center'
                        , render: function (data, type, row) {
                            if (type === 'display') {
                                return `<input type="checkbox" ${data == '1' ? 'checked' : ''} disabled>`;
                            }
                            return data;
                        }
                    },

                    //{data: 'printId', title: '인쇄ID'},
                   // {data: 'printMethod', title: '인쇄방법'},

                   // {data: 'itemName', title: '품목명'},
                   // {data: 'bagColor', title: '쇼핑백색상'},
                   // {data: 'sizeText', title: '사이즈'},
                    //{data: 'quantity', title: '제작장수'},

                   // {data: 'team', title: '인쇄담당팀'},
                   // {data: 'sides', title: '인쇄면'},

                ]
            });

            // 클릭 이벤트
            $('#grid tbody').on('click', 'tr', function () {
                const data = table.row(this).data();
                if (data) {
                    window.open(`assetDetail.html?printId=${data.printId}`, 'detailPopup', 'width=1000,height=1000');
                }
            });

            // 체크박스 클릭 시 해당 행 선택/해제
            $('#grid tbody').on('click', 'input.row-select', function (e) {
                const $row = $(this).closest('tr');
                // 행 선택/해제 토글
                $row.toggleClass('selected');
                $(this).prop('checked', $row.hasClass('selected'));

                e.stopPropagation(); // tr 클릭 이벤트 방지
            });

            // 선택된 행 가져오기
            function getSelectedRows() {
                return $('#grid tbody tr.selected').map(function () {
                    return $('#grid').DataTable().row(this).data();
                }).get();
            }

            // 상세보기 버튼
            $('#btnDetail').click(function () {
                const selected = getSelectedRows();
                if (selected.length === 0) {
                    alert("행을 선택해주세요.");
                    return;
                }
                // 선택된 행 중 첫 번째 항목의 상세 정보를 엽니다.
                const data = selected[0];
                window.open(`assetDetail.html?printId=${data.printId}`, 'detailPopup', 'width=1000,height=1000');
            });

            // 공통 액션 처리 함수
            function handleBatchAction(actionName, urlPath) {
                const selected = getSelectedRows();
                if (selected.length === 0) {
                    alert("행을 선택해주세요.");
                    return;
                }
                if (!confirm(`선택한 ${selected.length}개의 항목을 ${actionName} 처리하시겠습니까?`)) {
                    return;
                }

                const requests = selected.map(row => {
                    return $.post(`/api/print-info/${row.printId}/${urlPath}`, { status: 'Y' });
                });

                Promise.all(requests)
                    .then(responses => {
                        alert(`${responses.length}개의 항목이 성공적으로 ${actionName} 처리되었습니다.`);
                        $('#grid').DataTable().ajax.reload();
                    })
                    .catch(error => {
                        console.error(`${actionName} 처리 중 오류 발생:`, error);
                        alert("처리 중 오류가 발생했습니다. 콘솔을 확인해주세요.");
                        // 실패하더라도 테이블을 새로고침하여 최신 상태를 반영합니다.
                        $('#grid').DataTable().ajax.reload();
                    });
            }

            // 피킹완료 버튼
            $('#btnPicking').click(function () {
                handleBatchAction('피킹완료', 'picking');
            });

            // 출고준비완료 버튼
            $('#btnOutReady').click(function () {
                handleBatchAction('출고준비완료', 'out-ready');
            });
        });
    </script>

</body>

</html>