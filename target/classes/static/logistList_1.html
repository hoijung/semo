<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<title>물류팀대시보드(전체)</title>
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
	<style>
		body {
			font-family: 'Malgun Gothic', sans-serif;
			background-color: #f4f7fc;
			margin: 0;
			padding: 0;
		}

		.container {
			display: flex;
			flex-direction: column;
			height: 100vh;
		}

		.header {
			background-color: #2c3e50;
			color: white;
			padding: 15px 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.header h1 {
			margin: 0;
			font-size: 24px;
		}

		.menu-container {
			flex-shrink: 0;
		}

		.content {
			flex-grow: 1;
			padding: 20px;
			display: flex;
			flex-direction: column;
		}

		.search-area {
			background-color: white;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			margin-bottom: 20px;
		}

		.search-area h2 {
			margin-top: 0;
			margin-bottom: 15px;
			font-size: 18px;
			color: #333;
		}

		.search-filters {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
			gap: 15px;
			align-items: center;
		}

		.filter-group {
			display: flex;
			flex-direction: column;
		}

		.filter-group label {
			font-weight: bold;
			margin-bottom: 5px;
			font-size: 14px;
		}

		.filter-group input,
		.filter-group select {
			padding: 8px;
			border: 1px solid #ccc;
			border-radius: 4px;
			font-size: 14px;
		}

		.search-buttons {
			display: flex;
			justify-content: flex-end;
			margin-top: 20px;
		}

		.search-buttons button {
			padding: 10px 20px;
			font-size: 14px;
			border: none;
			border-radius: 5px;
			background-color: #3498db;
			color: white;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		.search-buttons button:hover {
			background-color: #2980b9;
		}

		.main-content {
			background-color: white;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			flex-grow: 1;
			display: flex;
			flex-direction: column;
		}
		
		.table-container {
			flex-grow: 1;
		}

		.action-buttons {
			display: flex;
			justify-content: flex-end;
			gap: 10px;
			margin-bottom: 15px;
		}

		.action-buttons button {
			padding: 8px 16px;
			font-size: 14px;
			border: 1px solid #888;
			border-radius: 5px;
			background-color: #f5f5f5;
			cursor: pointer;
			transition: background-color 0.2s, color 0.2s;
		}

		.action-buttons button:hover {
			background-color: #e0e0e0;
		}

		table.dataTable {
			width: 100%;
			border-collapse: collapse;
		}
		
		table.dataTable th,
		table.dataTable td {
			text-align: center;
			padding: 12px;
		}

		table.dataTable thead th {
			background-color: #f2f2f2;
			font-weight: bold;
		}
		
		input[type="checkbox"][disabled] {
			appearance: none;
			-webkit-appearance: none;
			width: 18px;
			height: 18px;
			border: 2px solid #000;
			border-radius: 3px;
			background-color: #fff;
			cursor: not-allowed;
		}

		input[type="checkbox"][disabled]:checked {
			background-color: #000;
			position: relative;
		}

		input[type="checkbox"][disabled]:checked::after {
			content: "✔";
			color: #fff;
			font-size: 14px;
			position: absolute;
			top: -2px;
			left: 2px;
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="header">
			<h1>ERP 시스템</h1>
			<div class="menu-container">
			</div>
		</div>
		<div class="content">
			<div class="search-area">
				<h2>조회 조건</h2>
				<form id="searchForm">
				<div class="search-filters">
					<div class="filter-group">
						<label for="pickingDate">피킹예정일</label>
						<input type="date" id="pickingDate" name="pickingDate">
					</div>
					<div class="filter-group">
						<label for="printTeam">담당팀</label>
						<input type="text" id="printTeam" name="printTeam">
					</div>
					<div class="filter-group">
						<label for="companyContact">업체명(고객명)</label>
						<input type="text" id="companyContact" name="companyContact">
					</div>
					<div class="filter-group">
						<label for="itemName">품목명</label>
						<input type="text" id="itemName" name="itemName">
					</div>
				</div>
				<div class="search-buttons">
					<button id="btnSearch">조회</button>
				</div>
				</form>
			</div>
			<div class="main-content">
				<div class="action-buttons">
					<button id="btnDetail">상세보기</button>
					<button id="btnPicking">피킹완료</button>
					<button id="btnOutReady">출고준비완료</button>
				</div>
				<div class="table-container">
					<table id="grid" class="display" style="width:100%"></table>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
	<script>
		$(document).ready(function () {

			// 1. .menu-container에 menu.html을 로드합니다.
			$('.menu-container').load('menu.html', function () {
				// 2. 메뉴 로드가 완료된 후, 이벤트 리스너를 설정하고 현재 페이지 메뉴를 활성화합니다.
				const menuBar = document.getElementById('menuBar');
				if (menuBar) {
					// 현재 페이지(main.html)에 해당하는 메뉴 항목에 'active' 클래스를 추가합니다.
					const currentPageMenuItem = menuBar.querySelector('[data-page="logistList_1.html"]');
					if (currentPageMenuItem) {
						// 기존 active 클래스를 모두 제거하고 현재 페이지만 활성화합니다.
						menuBar.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
						currentPageMenuItem.classList.add('active');
					}

					// 메뉴 클릭 이벤트 리스너
					menuBar.addEventListener('click', (event) => {
						const target = event.target.closest('.menu-item');
						if (target && !target.classList.contains('active')) {
							const pageToLoad = target.getAttribute('data-page');
							if (pageToLoad && pageToLoad !== 'initial') {
								location.href = pageToLoad;
							}
						}
					});
				}
			});

			const table = $('#grid').DataTable({
				responsive: true,
				ajax: {
					url: '/api/print-info/list1',
					dataSrc: 'data'
				},
				columns: [
					{
						title: '',  // 체크박스 컬럼
						orderable: false,
						className: 'dt-body-center',
						render: function (data, type, row, meta) {
							return `<input type="checkbox" class="row-select">`;
						}
					},
					{ data: 'pickingDate', title: '피킹예정일', className: 'dt-center' },
					{ data: 'printTeam', title: '담당팀' },
					{ data: 'companyContact', title: '업체명(고객명)' },
					{ data: 'itemName', title: '품목명' },
					{ data: 'bagColor', title: '컬러' },
					{ data: 'size', title: '사이즈' },
					{ data: 'quantity', title: '장수' },
					{
						data: "pickingYn", title: "피킹완료"
						, className: 'dt-center'
						, render: function (data, type, row) {
							if (type === 'display') {
								return `<input type="checkbox" ${data == '1' ? 'checked' : ''} disabled>`;
							}
							return data;
						}
					},
					{ data: 'phoneNumber', title: '전화번호' },
					{ data: 'deliveryZip', title: '우편번호', className: 'dt-center' },
					{ data: 'deliveryAddress', title: '주소' },
					{ data: 'sizeText', title: '박스규격' },
					{ data: 'printMethod', title: '발송마감일', className: 'dt-center' },
					{
						data: "outReadyYn", title: "출고준비"
						, className: 'dt-center'
						, render: function (data, type, row) {
							if (type === 'display') {
								return `<input type="checkbox" ${data == '1' ? 'checked' : ''} disabled>`;
							}
							return data;
						}
					},
				],
				searching: false, // 기본 검색 기능 비활성화
				lengthChange: false, // 표시 건수 변경 기능 비활성화
				pageLength: 15, // 기본 페이지당 행 수
				language: {
					emptyTable: "데이터가 없습니다.",
					info: "총 _TOTAL_개",
					infoEmpty: "",
					infoFiltered: "(_MAX_개 중에서 필터링됨)",
					paginate: {
						first: "<<",
						last: ">>",
						next: ">",
						previous: "<"
					}
				}
			});

			// 조회 버튼 클릭 이벤트
			$('#btnSearch').on('click', function () {
				table.ajax.url('/api/print-info/list1?' + $('#searchForm').serialize()).load();
			});

			// 클릭 이벤트
			$('#grid tbody').on('click', 'tr', function () {
				const data = table.row(this).data();
				if (data) {
					window.open(`assetDetail.html?printId=${data.printId}`, 'detailPopup', 'width=1000,height=1000');
				}
			});

			// 체크박스 클릭 시 해당 행 선택/해제
			$('#grid tbody').on('click', 'input.row-select', function (e) {
				const $row = $(this).closest('tr');
				// 행 선택/해제 토글
				$row.toggleClass('selected');
				$(this).prop('checked', $row.hasClass('selected'));

				e.stopPropagation(); // tr 클릭 이벤트 방지
			});

			// 선택된 행 가져오기
			function getSelectedRows() {
				return $('#grid tbody tr.selected').map(function () {
					return $('#grid').DataTable().row(this).data();
				}).get();
			}

			// 상세보기 버튼
			$('#btnDetail').click(function () {
				const selected = getSelectedRows();
				if (selected.length === 0) {
					alert("행을 선택해주세요.");
					return;
				}
				// 선택된 행 중 첫 번째 항목의 상세 정보를 엽니다.
				const data = selected[0];
				window.open(`assetDetail.html?printId=${data.printId}`, 'detailPopup', 'width=1000,height=1000');
			});

			// 공통 액션 처리 함수
			function handleBatchAction(actionName, urlPath) {
				const selected = getSelectedRows();
				if (selected.length === 0) {
					alert("행을 선택해주세요.");
					return;
				}
				if (!confirm(`선택한 ${selected.length}개의 항목을 ${actionName} 처리하시겠습니까?`)) {
					return;
				}

				const requests = selected.map(row => {
					return $.post(`/api/print-info/${row.printId}/${urlPath}`, { status: 'Y' });
				});

				Promise.all(requests)
					.then(responses => {
						alert(`${responses.length}개의 항목이 성공적으로 ${actionName} 처리되었습니다.`);
						$('#grid').DataTable().ajax.reload();
					})
					.catch(error => {
						console.error(`${actionName} 처리 중 오류 발생:`, error);
						alert("처리 중 오류가 발생했습니다. 콘솔을 확인해주세요.");
						// 실패하더라도 테이블을 새로고침하여 최신 상태를 반영합니다.
						$('#grid').DataTable().ajax.reload();
					});
			}

			// 피킹완료 버튼
			$('#btnPicking').click(function () {
				handleBatchAction('피킹완료', 'picking');
			});

			// 출고준비완료 버튼
			$('#btnOutReady').click(function () {
				handleBatchAction('출고준비완료', 'out-ready');
			});
		});
	</script>

</body>

</html>