<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>인쇄정보 관리</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            min-height: 100vh;
        }

        /* --- Global Layout --- */
        .main-content-wrapper {
            display: flex;
            flex: 1;
            width: 100%;
        }

        #list-container {
            width: 15%; /* Adjusted width for list for better visibility */
            padding: 20px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
            border-right: 1px solid #eee;
        }

        #detail-container {
            width: 85%; /* Adjusted width for detail */
            padding: 20px 30px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        /* --- Headings --- */
        #list-container h2, #detail-container h2 {
            color: #2c3e50;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex; /* Make h2 a flex container */
            justify-content: space-between; /* Space out title and buttons */
            align-items: center; /* Vertically align items */
        }

        /* --- Detail Header Buttons --- */
        #detail-header-buttons {
            display: flex;
            gap: 10px; /* Space between buttons */
        }

        #detail-header-buttons button {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Button specific colors */
        #detail-header-buttons #btnAdd.enabled { background-color: #28a745; }
        #detail-header-buttons #btnAdd.enabled:hover { background-color: #218838; }

        #detail-header-buttons #btnUpdate.enabled { background-color: #007bff; }
        #detail-header-buttons #btnUpdate.enabled:hover { background-color: #0056b3; }

        #detail-header-buttons #btnDelete.enabled { background-color: #dc3545; }
        #detail-header-buttons #btnDelete.enabled:hover { background-color: #c82333; }

        #detail-header-buttons button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            color: #888;
        }


        /* --- DataTables styles --- */
        #printTable {
            width: 100% !important;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #printTable th,
        #printTable td {
            border: 1px solid #e0e0e0;
            padding: 10px 12px;
            text-align: left;
            font-size: 0.95em;
        }

        #printTable th {
            background-color: #eaf6fd;
            font-weight: bold;
            color: #555;
        }

        #printTable tbody tr:hover {
            background-color: #f0f8ff;
            cursor: pointer;
        }

        #printTable tr.selected-row {
            background-color: #007bff !important;
            color: white;
        }

        /* --- Detail card styles --- */
        .detail-card {
            background: #fff;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .field-group {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e0e0e0;
        }

        .field-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .field-group>label {
            display: block;
            font-weight: bold;
            font-size: 1.1em;
            color: #34495e;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            padding-left: 10px;
        }

        .field-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 10px;
        }

        .field-row:last-child {
            margin-bottom: 0;
        }

        .field-item {
            display: flex;
            align-items: center;
            flex: 1 1 45%;
            min-width: 250px;
        }

        .field-item.full-width {
            flex: 1 1 100%;
        }

        .field-item span {
            width: 120px;
            min-width: 120px;
            font-weight: 600;
            color: #555;
            text-align: right;
            padding-right: 15px;
        }

        .field-item input[type="text"],
        .field-item input[type="number"],
        .field-item input[type="date"],
        .field-item textarea {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 0.95em;
            color: #333;
            transition: border-color 0.2s ease;
        }

        .field-item input:focus,
        .field-item textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .field-item textarea {
            min-height: 80px;
            resize: vertical;
        }

        .field-item input[type="checkbox"] {
            transform: scale(1.3);
            margin: 0 10px;
        }

        .field-item.checkbox-item span {
            width: auto;
            text-align: left;
            padding-right: 0;
        }
    </style>
</head>

<body>

    <div class="main-content-wrapper">
        <div id="list-container">
            <h2>인쇄정보 목록</h2>
            <table id="printTable" class="display">
                <thead>
                    <tr>
                        <th>인쇄ID</th>
                        <th>주문일자</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="detail-container">
            <h2>
                상세 정보
                <div id="detail-header-buttons">
                    <button type="button" id="btnAdd" class="enabled">등록</button>
                    <button type="button" id="btnUpdate">수정</button>
                    <button type="button" id="btnDelete">삭제</button>
                </div>
            </h2>
            <div class="detail-card">
                <input type="hidden" id="인쇄ID">

                <div class="field-group">
                    <label>기본 정보</label>
                    <div class="field-row">
                        <div class="field-item"><span>품목명:</span><input type="text" id="품목명"></div>
                        <div class="field-item"><span>사이즈:</span><input type="text" id="사이즈"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>쇼핑백색상:</span><input type="text" id="쇼핑백색상"></div>
                        <div class="field-item"><span>제작장수:</span><input type="number" id="제작장수"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>주문일자:</span><input type="date" id="주문일자"></div>
                        <div class="field-item"><span>판매채널:</span><input type="text" id="판매채널"></div>
                    </div>
                </div>

                <div class="field-group">
                    <label>인쇄 정보</label>
                    <div class="field-row">
                        <div class="field-item"><span>인쇄담당팀:</span><input type="text" id="인쇄담당팀"></div>
                        <div class="field-item"><span>인쇄면:</span><input type="text" id="인쇄면"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>인쇄도수:</span><input type="text" id="인쇄도수"></div>
                        <div class="field-item"><span>인쇄방식:</span><input type="text" id="인쇄방식"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>로고인쇄크기:</span><input type="text" id="로고인쇄크기"></div>
                        <div class="field-item"><span>로고인쇄위치:</span><input type="text" id="로고인쇄위치"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>파일명:</span><input type="text" id="파일명"></div>
                        <div class="field-item"><span>인쇄로고예시:</span><input type="text" id="인쇄로고예시"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>인쇄방법:</span><input type="text" id="인쇄방법"></div>
                    </div>
                </div>

                <div class="field-group">
                    <label>고객 / 배송 정보</label>
                    <div class="field-row">
                        <div class="field-item"><span>고객ID:</span><input type="text" id="고객ID"></div>
                        <div class="field-item"><span>업체명/담당자:</span><input type="text" id="업체명_담당자"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>전화번호:</span><input type="text" id="전화번호"></div>
                        <div class="field-item"><span>이메일:</span><input type="text" id="이메일"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>발송마감기한:</span><input type="date" id="발송마감기한"></div>
                        <div class="field-item"><span>피킹예정일:</span><input type="date" id="피킹예정일"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>배송지(우편번호):</span><input type="text" id="최종배송지_우편번호"></div>
                        <div class="field-item full-width"><span>배송지(주소):</span><input type="text" id="최종배송지_주소"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>배송타입:</span><input type="text" id="배송타입"></div>
                        <div class="field-item"><span>박스규격:</span><input type="text" id="박스규격"></div>
                    </div>
                </div>

                <div class="field-group">
                    <label>정산 및 관리 정보</label>
                    <div class="field-row">
                        <div class="field-item"><span>계산서발행타입:</span><input type="text" id="계산서발행타입"></div>
                        <div class="field-item"><span>상호명:</span><input type="text" id="상호명"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>대표자명:</span><input type="text" id="대표자명"></div>
                        <div class="field-item"><span>등록팀:</span><input type="text" id="등록팀"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>수정팀:</span><input type="text" id="수정팀"></div>
                        <div class="field-item"><span>공급가액:</span><input type="number" id="공급가액" step="0.01"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item"><span>부가세액:</span><input type="number" id="부가세액" step="0.01"></div>
                        <div class="field-item"><span>합계금액:</span><input type="number" id="합계금액" step="0.01"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item checkbox-item"><span>배분여부:</span><input type="checkbox" id="배분여부"></div>
                        <div class="field-item checkbox-item"><span>완료여부:</span><input type="checkbox" id="완료여부"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item checkbox-item"><span>피킹완료:</span><input type="checkbox" id="피킹완료"></div>
                        <div class="field-item checkbox-item"><span>출고준비:</span><input type="checkbox" id="출고준비"></div>
                    </div>
                    <div class="field-row">
                        <div class="field-item checkbox-item"><span>기존주문여부:</span><input type="checkbox" id="기존주문여부">
                        </div>
                    </div>
                </div>

                <div class="field-group">
                    <label>특이사항</label>
                    <div class="field-row">
                        <div class="field-item full-width"><span>내용:</span><textarea id="특이사항"></textarea></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        let table;
        let selectedRow = null; // 선택된 테이블 행 DOM 요소를 추적하기 위한 변수
        let currentSelectedId = null; // 현재 선택된 레코드의 고유 ID를 저장하는 변수

        $(document).ready(function () {
            table = $('#printTable').DataTable({
                ajax: { url: '/api/prints', dataSrc: '' },
                columns: [
                    { data: '인쇄ID' },
                    { data: '주문일자' } // DataTables는 '주문일자' 필드에서 직접 날짜 문자열을 가져옴
                ],
                paging: false,
                info: false,
                searching: false
            });

            // 테이블 행 클릭 이벤트
            $('#printTable tbody').on('click', 'tr', function () {
                const data = table.row(this).data();
                if (!data) return;

                // 기존 선택된 행의 클래스 제거
                if (selectedRow) {
                    $(selectedRow).removeClass('selected-row');
                }

                // 현재 클릭된 행에 클래스 추가 및 selectedRow 변수 업데이트
                $(this).addClass('selected-row');
                selectedRow = this;

                // 선택된 행의 인쇄ID 저장
                currentSelectedId = data.인쇄ID;

                fillDetailForm(data); // 상세 정보 폼 채우기
                updateButtonState(true); // 수정/삭제 버튼 활성화
            });

            // 버튼 이벤트 리스너
            $('#btnAdd').click(addRecord);
            $('#btnUpdate').click(updateRecord);
            $('#btnDelete').click(deleteRecord);

            // 초기 버튼 상태 설정 (수정/삭제 비활성화)
            updateButtonState(false);
        });

        function fillDetailForm(data) {
            // 폼 필드의 값을 먼저 초기화
            resetDetailFormValues();

            for (let key in data) {
                const el = $('#' + key);
                if (el.length) { // 해당 ID를 가진 요소가 존재하면
                    if (el.attr('type') === 'checkbox') {
                        el.prop('checked', data[key]);
                    } else if (el.attr('type') === 'date') {
                        // 서버에서 오는 날짜 문자열 (예: "YYYY-MM-DDTHH:MM:SS.sssZ" 또는 "YYYY-MM-DD")
                        //에서 'YYYY-MM-DD' 부분만 추출하여 date input에 설정
                        if (data[key]) {
                            el.val(data[key].substring(0, 10)); // YYYY-MM-DD
                        } else {
                            el.val(''); // 값이 없으면 빈 문자열
                        }
                    } else {
                        el.val(data[key]);
                    }
                }
            }
        }

        function getFormData() {
            const formData = {};
            // .detail-card 내부의 모든 input, textarea에서 데이터 추출
            $('.detail-card').find('input, textarea').each(function () {
                const id = $(this).attr('id');
                if (!id) return;

                if ($(this).attr('type') === 'checkbox') {
                    formData[id] = $(this).prop('checked');
                } else {
                    formData[id] = $(this).val();
                }
            });
            return formData;
        }

        // DataTables 재로드 및 선택된 행 복원 로직
        function reloadTableAndRestoreSelection() {
            table.ajax.reload(function () {
                if (currentSelectedId !== null) {
                    let foundRow = null;
                    // DataTables 내부 API를 사용하여 ID로 행 찾기
                    table.rows().every(function () {
                        const rowData = this.data();
                        if (rowData && rowData.인쇄ID === currentSelectedId) {
                            foundRow = this.node(); // DOM 노드 저장
                            fillDetailForm(rowData); // 최신 데이터로 폼 채우기
                            return false; // 루프 중단
                        }
                    });

                    // 이전에 선택된 행의 클래스 제거 (혹시 모를 경우를 대비)
                    $('#printTable tbody tr').removeClass('selected-row');

                    if (foundRow) {
                        $(foundRow).addClass('selected-row'); // 찾은 행에 클래스 추가
                        selectedRow = foundRow; // selectedRow 변수 업데이트
                        updateButtonState(true); // 버튼 활성화
                    } else {
                        // 선택했던 ID의 레코드가 더 이상 존재하지 않는 경우 (예: 삭제 후)
                        resetDetailForm();
                        updateButtonState(false);
                    }
                } else {
                    // currentSelectedId가 null인 경우 (추가 또는 삭제 후)
                    resetDetailForm(); // 폼 초기화
                    updateButtonState(false); // 버튼 비활성화
                }
            }, false); // `false`는 DataTables의 `resetPaging` 옵션으로, 페이지를 현재 상태로 유지
        }

        function addRecord() {
            const formData = getFormData();
            if (!confirm("등록 하시겠습니까?")) return;

            delete formData.인쇄ID; // 인쇄ID는 서버에서 자동 생성

            fetch('/api/prints', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error('Network response was not ok: ' + text) });
                    }
                    return response.json();
                })
                .then(data => {
                    alert("새 레코드가 등록되었습니다!");
                    currentSelectedId = null; // 등록 후에는 선택된 ID를 초기화
                    reloadTableAndRestoreSelection();
                })
                .catch(error => {
                    console.error("Add Error:", error);
                    alert("레코드 등록 실패: " + error.message);
                });
        }

        function updateRecord() {
            const id = $('#인쇄ID').val();
            if (!id) { alert("수정할 레코드를 선택하세요."); return; }
            if (!confirm("수정 하시겠습니까?")) return;

            fetch('/api/prints/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(getFormData())
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error('Network response was not ok: ' + text) });
                    }
                    return response.json();
                })
                .then(data => {
                    //alert("레코드가 성공적으로 수정되었습니다!");
                    // 수정 후에는 currentSelectedId를 유지한 채 재로드하여 포커스 복원
                    reloadTableAndRestoreSelection();
                })
                .catch(error => {
                    console.error("Update Error:", error);
                    alert("레코드 수정 실패: " + error.message);
                });
        }

        function deleteRecord() {
            const id = $('#인쇄ID').val();
            if (!id) { alert("삭제할 레코드를 선택하세요."); return; }
            if (!confirm("정말 삭제하시겠습니까?")) return;

            fetch('/api/prints/' + id, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error('Network response was not ok: ' + text) });
                    }
                    //alert("레코드가 성공적으로 삭제되었습니다!");
                    currentSelectedId = null; // 삭제 후에는 선택된 ID를 초기화
                    reloadTableAndRestoreSelection();
                })
                .catch(error => {
                    console.error("Delete Error:", error);
                    alert("레코드 삭제 실패: " + error.message);
                });
        }

        // 상세 정보 폼의 값만 초기화하는 함수
        function resetDetailFormValues() {
            $('#detail-container').find('input[type="text"], input[type="number"], input[type="date"], textarea').val('');
            $('#detail-container').find('input[type="checkbox"]').prop('checked', false);
            $('#인쇄ID').val(''); // 숨겨진 인쇄ID 필드 초기화
        }

        // 상세 정보 폼 전체를 초기화 (선택 상태까지)
        function resetDetailForm() {
            resetDetailFormValues(); // 값 초기화

            // 이전에 선택된 행이 있었다면 클래스 제거
            if (selectedRow) {
                $(selectedRow).removeClass('selected-row');
                selectedRow = null;
            }
            currentSelectedId = null; // 저장된 ID도 초기화
        }

        // 버튼 활성화/비활성화 함수
        function updateButtonState(enable) {
            // 등록 버튼은 항상 활성화
            $('#btnAdd').prop('disabled', false).addClass('enabled');

            // 수정, 삭제 버튼은 enable 값에 따라 활성화/비활성화
            $('#btnUpdate, #btnDelete').prop('disabled', !enable)
                .toggleClass('enabled', enable);
        }
    </script>
</body>

</html>